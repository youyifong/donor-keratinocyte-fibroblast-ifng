---
title: "Analysis"
date: "`r Sys.Date()`"
output: pdf_document
header-includes:
  - \usepackage{array}

---

```{r setup, include=FALSE}
library(kyotil)
library(knitr)
library(kableExtra)
library(lme4)
cytokines=c("CXCL10", "CCL5",  "IL15",  "IL12A", "IFI16")
donors=c(4,5,7,10,1,2,3,6,8,9)
doses=c("0", "0.1", "1", "10", "100")
tissues=c("Keratinocytes", "Fibroblasts")
times=c("Untreated", "4HPT", "24HPT")
```

## Background 

This project focuses on cytokines and their role in controlling viral replication within the epithelium. 

## Methods

Fold changes are computed from actin.

Linear mixed models are used to analyze the data. The models account for the random effects of donor variability.

\newpage
## Panel A

```{r panel A data, echo=F, message=F}

dat=read.csv("data/PanelA.csv")

# reshape to long format
dat.1 = list(dat[, c(1,2,3:5)], dat[, c(1,2,3:5+3)], dat[, c(1,2,3:5+6)], dat[, c(1,2,3:5+9)],
             dat[, c(1,2,3:5+12)], dat[, c(1,2,3:5+15)], dat[, c(1,2,3:5+18)], dat[, c(1,2,3:5+21)],
             dat[, c(1,2,3:5+24)], dat[, c(1,2,3:5+27)])
# add a donor column to each data frame
dat.1 = lapply (seq_along(donors), function (i) {
  x=dat.1[[i]]
  x$donor=donors[i]
  # reshape to long format for columns 3-5
  x=myreshapelong(x, cols.to.be.stacked=names(x)[3:5], label.cols.to.be.stacked="replicate", new.col.name="fold_change")
  rownames(x)=NULL
  x$id=NULL
  # change replicate to 2 if ends with .1, 3 if ends with .2, 1 otherwise
  x$replicate=ifelse(grepl("\\.1$", x$replicate), 2, ifelse(grepl("\\.2$", x$replicate), 3, 1))
  x
})

do.call(rbind, dat.1) -> dat.2
# remove reshapeLong attr
attr(dat.2, "reshapeLong")=NULL

# add a new column tissue = "keratinocyte" if exp starts with K or "fibroblast" if exp starts with F
dat.2$tissue=ifelse(grepl("^K", dat.2$exp), "keratinocyte", "fibroblast")
# add a new column trt = "treated" if exp ends with T or "untreated" if exp ends with U
dat.2$trt=ifelse(grepl("T$", dat.2$exp), "treated", "untreated")
# remove exp column
dat.2$exp=NULL

# make tissue, trt, cytokine, donor factors
dat.2$tissue=factor(dat.2$tissue)
dat.2$trt=factor(dat.2$trt, levels=c("untreated", "treated"))
dat.2$cytokine=factor(dat.2$cytokine, levels=cytokines)
dat.2$donor=factor(dat.2$donor)
dat.2$replicate=factor(dat.2$replicate)

# log10 transform y
dat.2$fold_change=log10(dat.2$fold_change)

dat=dat.2
```

**Question**: Is there a statistically significant difference between the treated group and its associated untreated control? 

For Keratinocyte, there are 10 donors; for Fibroblast, there are 4 donors.

```{r, echo=F, message=F}
mysapply(cytokines, function (c) {
  fit.1 = lmer(fold_change ~ trt + (1|donor), data=subset(dat, cytokine==c & tissue=="keratinocyte"))
  fit.2 = lmer(fold_change ~ trt + (1|donor), data=subset(dat, cytokine==c & tissue=="fibroblast"))
  tab=getFormattedSummary(list(Keratinocyte=fit.1, Fibroblast=fit.2), robust=F, p.digits=3, exp10=T, trunc.large.est = F)
  tab[2,]
}) -> tab
kable(tab, align='l') %>%kable_styling(latex_options = "hold_position")%>% row_spec(0, bold = TRUE, align = "c")%>%row_spec(1:4, extra_latex_after = "\\addlinespace[4pt]")
```
Treated versus untreated is highly significant except for CCL5 on fibroblasts.

\bigskip

**Question**: Is there a statistically significant difference between treated keratinocytes and treated fibroblasts

```{r, echo=F, message=F}
mysapply(cytokines, function (c) {
  fit.1 = lmer(fold_change ~ tissue + (1|donor), data=subset(dat, cytokine==c & trt=="treated"))
  fit.2 = lmer(fold_change ~ tissue + (1|donor), data=subset(dat, cytokine==c & trt=="untreated"))
  tab=getFormattedSummary(list(Treated=fit.1, Untreated=fit.2), robust=F, p.digits=3, exp10=T, trunc.large.est = F)
  tab[2,]
}) -> tab
kable(tab, align='l') %>%kable_styling(latex_options = "hold_position")%>% row_spec(0, bold = TRUE, align = "c")%>%row_spec(1:4, extra_latex_after = "\\addlinespace[4pt]")
```
Treated keratinocytes versus treated fibroblasts is highly significant except for CCL5. Untreated keratinocytes versus untreated fibroblasts is not significant for any cytokine.






\newpage

## Panel B

```{r panel B data, echo=F, message=F}

dat=read.csv("data/PanelB.csv")

# reshape to long format
dat.1 = list(dat[, c(1:3,4:6)], dat[, c(1:3,4:6+3)], dat[, c(1:3,4:6+6)], dat[, c(1:3,4:6+9)],
             dat[, c(1:3,4:6+12)], dat[, c(1:3,4:6+15)], dat[, c(1:3,4:6+18)], dat[, c(1:3,4:6+21)],
             dat[, c(1:3,4:6+24)], dat[, c(1:3,4:6+27)])
# add a donor column to each data frame
dat.1 = lapply (seq_along(donors), function (i) {
  x=dat.1[[i]]
  x$donor=donors[i]
  # reshape to long format for columns 4-6
  x=myreshapelong(x, cols.to.be.stacked=names(x)[4:6], label.cols.to.be.stacked="replicate", new.col.name="dCt")
  rownames(x)=NULL
  x$id=NULL
  # change replicate to 2 if ends with .1, 3 if ends with .2, 1 otherwise
  x$replicate=ifelse(grepl("\\.1$", x$replicate), 2, ifelse(grepl("\\.2$", x$replicate), 3, 1))
  x
})

do.call(rbind, dat.1) -> dat.2
# remove reshapeLong attr
attr(dat.2, "reshapeLong")=NULL

# make tissue, trt, cytokine, donor factors
dat.2$tissue=factor(dat.2$tissue)
dat.2$dose=factor(dat.2$dose, levels=doses)
dat.2$cytokine=factor(dat.2$cytokine, levels=cytokines)
dat.2$donor=factor(dat.2$donor)
dat.2$replicate=factor(dat.2$replicate)

dat=dat.2

```

**Question**: Is there a statistically significant difference between keratinocytes (orange) and fibroblasts (blue) at each dose in each cytokine of interest?

```{r, echo=F, message=F}
mysapply(cytokines, function (c) {
  fits = lapply(doses, function(d) lmer(dCt ~ tissue + (1|donor), data=subset(dat, cytokine==c & dose==d)))
  names(fits)=doses
  tab=getFormattedSummary(fits, robust=F, p.digits=3, exp10=F, trunc.large.est = F)
  tab[2,]
}) -> tab
kable(tab, align='l') %>%kable_styling(latex_options = "hold_position") %>% row_spec(0, bold = TRUE, align = "c")%>%column_spec(1, width = "1.1cm") %>%  column_spec(2:(ncol(tab)+1), width = "3cm")%>%  row_spec(1:4, extra_latex_after = "\\addlinespace[6pt]")
```

\bigskip

**Question**: For each tissue, is there a statistically significant difference between each dose and the next lower dose? IE is there a difference between 0.1 and 1, 1 and 10, 10 and 100? The goal of this question is to establish what dose is the peak response

```{r, echo=F, message=F}
tabs=list()
for (j in 1:2) {
  tabs[[j]] = mysapply(cytokines, function (c) {
    fits = lapply(seq_along(doses)[-1], function(i) lmer(dCt ~ dose + (1|donor), data=subset(dat, tissue==tissues[j] & cytokine==c & dose %in% doses[c(i-1,i)])))
    names(fits)=paste0(doses[2:length(doses)], " vs. ", doses[2:length(doses)-1])
    tab=getFormattedSummary(fits, robust=F, p.digits=3, exp10=F, trunc.large.est = F)
    tab[2,]
  }) 
}
# combine the two tables by interspering the rows
tab=do.call(rbind, lapply(1:nrow(tabs[[1]]), function(i) {
  rbind(tabs[[1]][i,], tabs[[2]][i,])
}))
rownames(tab)=c(t(outer(cytokines, tissues, paste, sep=", ")))
kable(tab)%>%kable_styling(latex_options = "hold_position") %>% row_spec(0, bold = TRUE, align = "c")%>%column_spec(1, width = "2.5cm") %>%  column_spec(2:(ncol(tab)+1), width = "3cm")%>%  row_spec(1:9, extra_latex_after = "\\addlinespace[6pt]")
```



\newpage
## Panel C

```{r panel C data, echo=F, message=F}

dat=read.csv("data/PanelC.csv")

# reshape to long format
dat.1 = list(dat[, c(1:3,4:6)], dat[, c(1:3,4:6+3)], dat[, c(1:3,4:6+6)], dat[, c(1:3,4:6+9)],
             dat[, c(1:3,4:6+12)], dat[, c(1:3,4:6+15)], dat[, c(1:3,4:6+18)], dat[, c(1:3,4:6+21)],
             dat[, c(1:3,4:6+24)], dat[, c(1:3,4:6+27)])
# add a donor column to each data frame
dat.1 = lapply (seq_along(donors), function (i) {
  x=dat.1[[i]]
  x$donor=donors[i]
  # reshape to long format for columns 4-6
  x=myreshapelong(x, cols.to.be.stacked=names(x)[4:6], label.cols.to.be.stacked="replicate", new.col.name="fold_change")
  rownames(x)=NULL
  x$id=NULL
  # change replicate to 2 if ends with .1, 3 if ends with .2, 1 otherwise
  x$replicate=ifelse(grepl("\\.1$", x$replicate), 2, ifelse(grepl("\\.2$", x$replicate), 3, 1))
  x
})

do.call(rbind, dat.1) -> dat.2
# remove reshapeLong attr
attr(dat.2, "reshapeLong")=NULL

# make tissue, trt, cytokine, donor factors
dat.2$tissue=factor(dat.2$tissue)
dat.2$dose=factor(dat.2$dose, levels=doses)
dat.2$cytokine=factor(dat.2$cytokine, levels=cytokines)
dat.2$donor=factor(dat.2$donor)
dat.2$replicate=factor(dat.2$replicate)

# log10 transform y
dat.2$fold_change=log10(dat.2$fold_change)

dat=dat.2
```

**Question**: Is there a statistically significant difference between keratinocytes (orange) and fibroblasts (blue) at each dose in each cytokine of interest?

```{r, echo=F, message=F}
mysapply(cytokines, function (c) {
  fits = lapply(doses, function(d) lmer(fold_change ~ tissue + (1|donor), data=subset(dat, cytokine==c & dose==d)))
  names(fits)=doses
  tab=getFormattedSummary(fits, robust=F, p.digits=3, exp10=T, trunc.large.est = F)
  tab[2,]
}) -> tab
kable(tab, align='l') %>%kable_styling(latex_options = "hold_position") %>% row_spec(0, bold = TRUE, align = "c")%>%column_spec(1, width = "1.1cm") %>%  column_spec(2:(ncol(tab)+1), width = "3cm")%>%  row_spec(1:4, extra_latex_after = "\\addlinespace[6pt]")
```


**Question**: For each tissue, is there a statistically significant difference between each dose and the next lower dose? The goal of this question is to establish what dose is the peak response

```{r, echo=F, message=F}
tabs=list()
for (j in 1:2) {
  tabs[[j]] = mysapply(cytokines, function (c) {
    fits = lapply(seq_along(doses)[-1], function(i) lmer(fold_change ~ dose + (1|donor), data=subset(dat, tissue==tissues[j] & cytokine==c & dose %in% doses[c(i-1,i)])))
    names(fits)=paste0(doses[2:length(doses)], " vs. ", doses[2:length(doses)-1])
    tab=getFormattedSummary(fits, robust=F, p.digits=3, exp10=T, trunc.large.est = F)
    tab[2,]
  }) 
}
# combine the two tables by interspering the rows
tab=do.call(rbind, lapply(1:nrow(tabs[[1]]), function(i) {
  rbind(tabs[[1]][i,], tabs[[2]][i,])
}))
rownames(tab)=c(t(outer(cytokines, tissues, paste, sep=", ")))
kable(tab)%>%kable_styling(latex_options = "hold_position") %>% row_spec(0, bold = TRUE, align = "c")%>%column_spec(1, width = "2.5cm") %>%  column_spec(2:(ncol(tab)+1), width = "3cm")%>%  row_spec(1:9, extra_latex_after = "\\addlinespace[5pt]")
```



\newpage
## Panel D

```{r panel D data, echo=F, message=F}

dat=read.csv("data/PanelD.csv")

# reshape to long format
dat.1 = list(dat[, c(1:3,4:6)], dat[, c(1:3,4:6+3)], dat[, c(1:3,4:6+6)], dat[, c(1:3,4:6+9)],
             dat[, c(1:3,4:6+12)], dat[, c(1:3,4:6+15)], dat[, c(1:3,4:6+18)], dat[, c(1:3,4:6+21)],
             dat[, c(1:3,4:6+24)], dat[, c(1:3,4:6+27)])
# add a donor column to each data frame
dat.1 = lapply (seq_along(donors), function (i) {
  x=dat.1[[i]]
  x$donor=donors[i]
  # reshape to long format for columns 4-6
  x=myreshapelong(x, cols.to.be.stacked=names(x)[4:6], label.cols.to.be.stacked="replicate", new.col.name="fold_change")
  rownames(x)=NULL
  x$id=NULL
  # change replicate to 2 if ends with .1, 3 if ends with .2, 1 otherwise
  x$replicate=ifelse(grepl("\\.1$", x$replicate), 2, ifelse(grepl("\\.2$", x$replicate), 3, 1))
  x
})

do.call(rbind, dat.1) -> dat.2
# remove reshapeLong attr
attr(dat.2, "reshapeLong")=NULL

# make tissue, trt, cytokine, donor factors
dat.2$tissue=factor(dat.2$tissue)
dat.2$time=factor(dat.2$time, levels=times)
dat.2$cytokine=factor(dat.2$cytokine, levels=cytokines)
dat.2$donor=factor(dat.2$donor)
dat.2$replicate=factor(dat.2$replicate)

# log10 transform y
dat.2$fold_change=log10(dat.2$fold_change)

dat=dat.2
```

**Question**: Is there a statistically significant difference between keratinocytes (orange) and fibroblasts (blue) at each time point for each cytokine individually? 

```{r, echo=F, message=F}
mysapply(cytokines, function (c) {
  fits = lapply(times, function(t) lmer(fold_change ~ tissue + (1|donor), data=subset(dat, cytokine==c & time==t)))
  names(fits)=times
  tab=getFormattedSummary(fits, robust=F, p.digits=3, exp10=T, trunc.large.est = F)
  tab[2,]
}) -> tab
kable(tab, align='l') %>%kable_styling(latex_options = "hold_position") %>% row_spec(0, bold = TRUE, align = "c")%>%column_spec(1, width = "1.1cm") %>%  column_spec(2:(ncol(tab)+1), width = "3cm")%>%  row_spec(1:4, extra_latex_after = "\\addlinespace[5pt]")
```


**Question**: For fibroblasts, is there a statistically significant difference between untreated and 4HPT for each cytokine? Is there a statistically significant difference between 4HPT and 24HPT for each cytokine?

```{r, echo=F, message=F}
tabs=list()
for (j in 1:2) {
  tabs[[j]] = mysapply(cytokines, function (c) {
    fits = lapply(seq_along(times)[-1], function(i) lmer(fold_change ~ time + (1|donor), data=subset(dat, tissue==tissues[j] & cytokine==c & time %in% times[c(i-1,i)])))
    names(fits)=paste0(times[2:length(times)], " vs. ", times[2:length(times)-1])
    tab=getFormattedSummary(fits, robust=F, p.digits=3, exp10=T, trunc.large.est = F)
    tab[2,]
  }) 
}
# combine the two tables by interspering the rows
tab=do.call(rbind, lapply(1:nrow(tabs[[1]]), function(i) {
  rbind(tabs[[1]][i,], tabs[[2]][i,])
}))
rownames(tab)=c(t(outer(cytokines, tissues, paste, sep=", ")))
kable(tab)%>%kable_styling(latex_options = "hold_position") %>% row_spec(0, bold = TRUE, align = "c")%>%column_spec(1, width = "2.5cm") %>%  column_spec(2:(ncol(tab)+1), width = "3cm")%>%  row_spec(1:9, extra_latex_after = "\\addlinespace[5pt]")
```

\newpage
# Appendix
```{r, echo = FALSE, message = FALSE, warning = FALSE, results='asis'}
commit_hash <- system("git rev-parse HEAD", intern = TRUE)
git_url <- sub("\\.git$", paste0("/commits/", commit_hash), system("git remote get-url origin", intern = TRUE))
cat("This report was built with code from [", sprintf("**[this commit](%s)**", git_url), "].", sep="")
```    